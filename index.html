<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Tribo Pay - Pagamentos PIX</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #4CAF50, #2e7d32);
            padding: 40px;
            color: #fff;
            text-align: center;
        }
        .container {
            max-width: 420px;
            margin: auto;
        }
        .card {
            background: #ffffff;
            width: 100%;
            color: #333;
            padding: 25px;
            border-radius: 14px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.2);
            text-align: center;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
        }
        button {
            width: 100%;
            padding: 12px;
            background: #2e7d32;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 17px;
            cursor: pointer;
            transition: 0.3s;
        }
        button:hover {
            background: #1b5e20;
        }
        .qr-container img {
            margin-top: 15px;
            border-radius: 8px;
        }
        #painel {
            margin-top: 50px;
            background: #fff;
            color: #000;
            padding: 20px;
            border-radius: 10px;
            text-align: left;
        }
        .status {
            padding: 8px;
            margin: 3px 0;
            border-left: 6px solid #4CAF50;
            background: #e8f5e9;
        }
    .loader {border: 5px solid #f3f3f3;border-top: 5px solid #2e7d32;border-radius: 50%;width: 40px;height: 40px;margin: auto;animation: spin 1s linear infinite;}@keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}
        button.copy-btn {background:#1b5e20;padding:8px 12px;margin-top:10px;font-size:14px;}
    </style>
</head>
<body>

    <div class="container">
        <h1>Pagamento via PIX - Tribo Pay</h1>

        <div class="card">
            <h3>Gerar cobrança PIX</h3>

            <input type="number" id="valor" placeholder="Valor (R$)">
            <input type="text" id="nome" placeholder="Nome do pagador">
            <input type="email" id="email" placeholder="E-mail">
            <input type="text" id="documento" placeholder="Documento (CPF)">

            <button onclick="gerarPix()">Gerar PIX</button>

            <div id="resultado"></div>
        </div>

        <div id="painel">
            <h3>Painel de Pagamentos</h3>
            <div id="lista-status"></div>
        </div>
    </div>

<script>
let pagamentos = [];

function adicionarStatus(id, status) {
    const lista = document.getElementById("lista-status");
    lista.innerHTML += `<div class='status'><strong>ID:</strong> ${id} — <strong>Status:</strong> ${status}</div>`;
}

async function verificarStatus(id) {
    try {
        const response = await fetch(`/api/status/${id}`, {
            headers: {
                "Content-Type": "application/json"
            }
        });
        const data = await response.json();

        adicionarStatus(id, data.status || "desconhecido");
    } catch (e) {
        adicionarStatus(id, "erro ao verificar");
    }
}

async function gerarPix() {
    const valor = document.getElementById("valor").value;
    const nome = document.getElementById("nome").value;
    const email = document.getElementById("email").value;
    const documento = document.getElementById("documento").value;
    const resultadoDiv = document.getElementById("resultado");

    if (!valor || valor <= 0) return alert("Digite um valor válido.");
    if (nome.length < 3) return alert("Nome inválido.");
    if (!email.includes("@")) return alert("E-mail inválido.");
    if (documento.length < 11) return alert("Documento inválido.");

    resultadoDiv.innerHTML = `<div class='loader'></div><p>Gerando cobrança PIX...</p>`;

    try {
        const response = await fetch("/api/pix", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Accept": "application/json"
            },
            body: JSON.stringify({
                amount: Number(valor),
                externalId: "pedido_teste_001",
                postbackUrl: "http://example.com",
                method: "pix",
                transactionOrigin: "cashin",
                payer: {
                    name: nome,
                    email: email,
                    document: documento
                }
            })
        });

        const data = await response.json();

        if (data.id) {
            pagamentos.push(data.id);
            verificarStatus(data.id);
        }

        if (data.pix && data.pix.imageBase64) {
            resultadoDiv.innerHTML = `
                <h3>Escaneie o QR Code:</h3>
                <div class="qr-container">
                    <img src="data:image/png;base64,${data.pix.imageBase64}" width="220">
                </div>
                <p><strong>Código Copia e Cola:</strong></p>
                <textarea id='pixCode' style="width:100%; height:120px;">${data.pix.code}</textarea><button class='copy-btn' onclick="copyPix()">Copiar Código</button>
            `;
        } else {
            resultadoDiv.innerHTML = "<p>Erro ao gerar PIX.</p>";
        }

    } catch (e) {
        resultadoDiv.innerHTML = "<p>Erro na requisição.</p>";
    }
}
function copyPix(){const t=document.getElementById('pixCode');t.select();navigator.clipboard.writeText(t.value);alert('Código PIX copiado!');}
</script>

</body>
</html>
